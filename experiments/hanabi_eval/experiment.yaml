schema_version: 1
name: hanabi_eval
kind: rollout_eval
description: Baseline evaluation for Hanabi using a fixed protocol (repeatable across model/prompt changes).
tags: ["eval", "rollout", "hanabi"]

repro:
  seed: 0
  python: ">=3.10,<3.13"

spec:
  env_id: "Hanabi-v0-train"
  num_players: 2
  episodes: 20
  agents:
    - "qwen:Qwen/Qwen3-VL-4B-Instruct"
    - "qwen:Qwen/Qwen3-VL-4B-Instruct"
  system_prompt: "You are an expert Hanabi teammate. Output exactly ONE valid action and nothing else. Valid formats: [Discard] X | [Play] X | [Reveal] player N card X color C | [Reveal] player N card X rank R. If you [Reveal], it must be truthful for that specific card index (color in {white,yellow,green,blue,red} or rank in {1,2,3,4,5})."
  # Optional: only used for openai:/qwen: agents. If null, uses OPENAI_BASE_URL / OPENAI_API_KEY (e.g. OpenRouter).
  openai_base_url: null
  openai_api_key: null
  timeout_s: 120
  gen:
    # Eval-oriented defaults for "single action only" games:
    # - low randomness to reduce invalid format
    # - cap output length to prevent explanations
    temperature: 0.2
    top_p: 1.0
    top_k: null
    repetition_penalty: null
    presence_penalty: 0.0
    frequency_penalty: 0.0
    gen_seed: null
    extra_body: null
    chat_template_kwargs: null
    disable_thinking: false
    max_tokens: null

commands:
  - >-
    python tools/rollout/run_rollouts.py
    --env-id {spec.env_id}
    --num-players {spec.num_players}
    --episodes {spec.episodes}
    --seed {repro.seed}
    {agent_flags}
    --system-prompt {sh:spec.system_prompt}
    {opt:--openai-base-url spec.openai_base_url}
    {opt:--openai-api-key spec.openai_api_key}
    {opt:--timeout spec.timeout_s}
    --temperature {spec.gen.temperature}
    --top-p {spec.gen.top_p}
    {opt:--top-k spec.gen.top_k}
    {opt:--repetition-penalty spec.gen.repetition_penalty}
    {opt:--presence-penalty spec.gen.presence_penalty}
    {opt:--frequency-penalty spec.gen.frequency_penalty}
    {opt:--gen-seed spec.gen.gen_seed}
    {optsh:--extra-body spec.gen.extra_body}
    {optsh:--chat-template-kwargs spec.gen.chat_template_kwargs}
    {flag:--disable-thinking spec.gen.disable_thinking}
    {opt:--max-tokens spec.gen.max_tokens}
    --episode-json-dir {run_dir}/episodes
    --out {run_dir}/rollouts.jsonl
  - >-
    python tools/rollout/summarize_rollouts.py {run_dir}/rollouts.jsonl
    --json > {run_dir}/summary.json

outputs:
  files:
    - "{run_dir}/rollouts.jsonl"
    - "{run_dir}/summary.json"
